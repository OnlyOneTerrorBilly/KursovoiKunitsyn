<Page x:Class="Kursovoi.Pages.SpecifikaciyaNaIzdeliePage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:Kursovoi.Pages"
      mc:Ignorable="d" 
      d:DesignHeight="700" d:DesignWidth="1200"
      Title="SpecifikaciyaNaIzdeliePage" Loaded="Page_Loaded">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="4*" MinWidth="350"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="6*" MinWidth="600"/>
        </Grid.ColumnDefinitions>

        <!-- Левая панель - Список спецификаций -->
        <Border Grid.Column="0" Background="White" BorderBrush="#FFE0E0E0" BorderThickness="0,0,1,0">
            <DockPanel>
                <!-- Панель инструментов -->
                <ToolBar DockPanel.Dock="Top" Background="#FF2C3E50">
                    <Button x:Name="AddButton" Content="+ Новая" Click="AddButton_Click"
                            ToolTip="Создать новую спецификацию" Height="30" Width="80" Margin="2" Foreground="White"/>
                    <Button x:Name="EditButton" Content="✏ Изменить" Click="EditButton_Click"
                            ToolTip="Редактировать выбранную спецификацию" Height="30" Width="90" Margin="2" Foreground="White"/>
                    <Button x:Name="DeleteButton" Content="🗑 Удалить" Click="DeleteButton_Click"
                            ToolTip="Удалить выбранную спецификацию" Height="30" Width="90" Margin="2" Foreground="White"/>
                    <Separator/>
                    <TextBlock Text="Поиск:" VerticalAlignment="Center" Margin="5,0" Foreground="White"/>
                    <TextBox x:Name="SearchBox" Width="150" Height="25" 
                             TextChanged="SearchBox_TextChanged" VerticalContentAlignment="Center"/>
                </ToolBar>

                <!-- Список спецификаций -->
                <DataGrid x:Name="SpecifikaciiGrid" 
                          SelectionChanged="SpecifikaciiGrid_SelectionChanged"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          SelectionMode="Single"
                          HeadersVisibility="Column"
                          GridLinesVisibility="Horizontal"
                          RowDetailsVisibilityMode="Collapsed"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          CanUserReorderColumns="False"
                          CanUserResizeRows="False"
                          CanUserSortColumns="True"
                          Margin="0" Background="#FF2C3E50">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="№" Binding="{Binding Id_SpecifikaciyaNaIzdelie}" 
                                          Width="50" IsReadOnly="True"/>
                        <DataGridTextColumn Header="Дата" Binding="{Binding DataSozdaniyaSpecifikacii, StringFormat=dd.MM.yyyy}" 
                                          Width="80"/>
                        <DataGridTextColumn Header="Заказ" 
                                          Binding="{Binding OformlenieZakaza.NaimenovanieZakaza}"
                                          Width="*" MinWidth="150"/>
                        <DataGridTextColumn Header="Клиент" 
                                          Binding="{Binding Zakazchiki.FullName}"
                                          Width="120"/>
                    </DataGrid.Columns>
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Setter Property="Height" Value="30"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#FF9B59B6"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                </DataGrid>
            </DockPanel>
        </Border>

        <!-- Splitter -->
        <GridSplitter Grid.Column="1" Width="5" Background="#FFE0E0E0" 
                      HorizontalAlignment="Center" VerticalAlignment="Stretch"
                      ResizeBehavior="PreviousAndNext"
                      ShowsPreview="True"/>

        <!-- Правая панель - Форма редактирования -->
        <Border Grid.Column="2" Background="White">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Background="#FF2C3E50">
                <StackPanel Margin="20" x:Name="FormPanel">
                    <!-- Заголовок формы -->
                    <Border Background="#FF2C3E50" CornerRadius="3" Padding="10" Margin="0,0,0,15">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Button x:Name="BackButton" Content="← Назад" 
                                    Width="80" Height="25" Margin="0,0,15,0"
                                    Background="#FF3498DB" Foreground="White"
                                    FontWeight="Bold" Click="BackButton_Click"/>
                            <TextBlock x:Name="FormTitle" Text="НОВАЯ СПЕЦИФИКАЦИЯ" 
                                       FontSize="16" FontWeight="Bold" Foreground="White"/>
                        </StackPanel>
                    </Border>

                    <!-- Основные поля -->
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Номер спецификации -->
                        <Label Grid.Row="0" Grid.Column="0" Content="Номер:" 
                               HorizontalAlignment="Right" Margin="0,5,10,5" Foreground="White"/>
                        <TextBox Grid.Row="0" Grid.Column="1" x:Name="NumberBox" 
                                 IsReadOnly="True" Height="25" Margin="0,5,0,5"
                                 Background="#FFF9F9F9" Foreground="Gray"/>

                        <!-- Дата создания -->
                        <Label Grid.Row="1" Grid.Column="0" Content="Дата:" 
                               HorizontalAlignment="Right" Margin="0,5,10,5" Foreground="White"/>
                        <DatePicker Grid.Row="1" Grid.Column="1" x:Name="DatePicker" 
                                    Height="25" Margin="0,5,0,5"/>

                        <!-- Заказ -->
                        <Label Grid.Row="2" Grid.Column="0" Content="Заказ:" 
                               HorizontalAlignment="Right" Margin="0,5,10,5" Foreground="White"/>
                        <ComboBox Grid.Row="2" Grid.Column="1" x:Name="OrderComboBox" 
                                  Height="25" Margin="0,5,0,5"
                                  DisplayMemberPath="NaimenovanieZakaza"
                                  SelectedValuePath="Id_OformlenieZakaza"
                                  SelectionChanged="OrderComboBox_SelectionChanged"/>

                        <!-- Заказчик -->
                        <Label Grid.Row="3" Grid.Column="0" Content="Заказчик:" 
                               HorizontalAlignment="Right" Margin="0,5,10,5" Foreground="White"/>
                        <TextBox Grid.Row="3" Grid.Column="1" x:Name="ClientBox" 
                                 IsReadOnly="True" Height="25" Margin="0,5,0,5"
                                 Background="#FFF9F9F9" Foreground="Gray"/>

                        <!-- Изделие -->
                        <Label Grid.Row="4" Grid.Column="0" Content="Изделие:" 
                               HorizontalAlignment="Right" Margin="0,5,10,5" Foreground="White"/>
                        <TextBox Grid.Row="4" Grid.Column="1" x:Name="ProductBox" 
                                 Height="25" Margin="0,5,0,5"/>
                    </Grid>

                    <!-- Размеры готового изделия -->
                    <Label Margin="0,15,0,5" Content="Размеры готового изделия:" Foreground="White"/>
                    <TextBox x:Name="DimensionsBox" 
                             Height="60" Margin="0,0,0,15" 
                             TextWrapping="Wrap" AcceptsReturn="True"
                             VerticalScrollBarVisibility="Auto"/>

                    <!-- Материалы и фурнитура -->
                    <Border BorderBrush="#FFE0E0E0" BorderThickness="1" CornerRadius="3" 
                            Margin="0,0,0,0" Padding="0">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Заголовок таблицы -->
                            <Border Grid.Row="0" Background="#FF2C3E50" 
                                    BorderThickness="0,0,0,1" Padding="10,5">
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="МАТЕРИАЛЫ И ФУРНИТУРА" FontWeight="Bold" Foreground="White"/>
                                    <Button x:Name="AddMaterialButton" Content="+ Добавить" 
                                            Width="100" Height="25" Margin="15,0,0,0"
                                            Background="#FF3498DB" Foreground="White"
                                            Click="AddMaterialButton_Click"/>
                                </StackPanel>
                            </Border>

                            <!-- Таблица материалов -->
                            <DataGrid Grid.Row="1" x:Name="MaterialsGrid"
                                      AutoGenerateColumns="False"
                                      CanUserAddRows="True"
                                      CanUserDeleteRows="True"
                                      HeadersVisibility="Column"
                                      SelectionMode="Single"
                                      SelectionUnit="FullRow"
                                      Margin="0"
                                      AddingNewItem="MaterialsGrid_AddingNewItem">
                                <DataGrid.Columns>
                                    <DataGridComboBoxColumn Header="Материал/Фурнитура" 
                                        Width="*" MinWidth="200" x:Name="MaterialColumn">
                                        <DataGridComboBoxColumn.ElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.MaterialColumn.ItemsSource, RelativeSource={RelativeSource AncestorType=Page}}"/>
                                                <Setter Property="DisplayMemberPath" Value="Name_MaterialyIFurnitura"/>
                                                <Setter Property="SelectedValuePath" Value="Id_MaterialyIFurnitura"/>
                                                <Setter Property="SelectedValue" Value="{Binding Id_Materiala, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.ElementStyle>
                                        <DataGridComboBoxColumn.EditingElementStyle>
                                            <Style TargetType="ComboBox">
                                                <Setter Property="ItemsSource" Value="{Binding DataContext.MaterialColumn.ItemsSource, RelativeSource={RelativeSource AncestorType=Page}}"/>
                                                <Setter Property="DisplayMemberPath" Value="Name_MaterialyIFurnitura"/>
                                                <Setter Property="SelectedValuePath" Value="Id_MaterialyIFurnitura"/>
                                                <Setter Property="SelectedValue" Value="{Binding Id_Materiala, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                                            </Style>
                                        </DataGridComboBoxColumn.EditingElementStyle>
                                    </DataGridComboBoxColumn>

                                    <DataGridTextColumn Header="Кол-во" 
                                                        Binding="{Binding Kolichestvo_SpecifikaciyaMaterialy, Mode=TwoWay}"
                                                        Width="80"/>

                                    <DataGridTemplateColumn Header="Действие" Width="60">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <Button Content="✕" Width="25" Height="25" 
                                                        Background="#FFE74C3C" Foreground="White"
                                                        Click="RemoveMaterialButton_Click"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </DataGrid.Columns>
                            </DataGrid>

                            <!-- Итого материалов -->
                            <Border Grid.Row="2" Background="#FF2C3E50"  
                                    BorderThickness="0,1,0,0" Padding="10,5">
                                <TextBlock x:Name="MaterialsCountText" Text="Материалов: 0" Foreground="White"/>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Сообщения об ошибках -->
                    <Border x:Name="ErrorBorder" Background="#FFFDE8E8" BorderBrush="#FFE74C3C" 
                            BorderThickness="1" CornerRadius="3" Padding="10" Margin="0,20,0,0"
                            Visibility="Collapsed">
                        <TextBlock x:Name="ErrorText" Foreground="#FFC0392B" TextWrapping="Wrap"/>
                    </Border>

                    <!-- Кнопки формы -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,30,0,0">
                        <Button x:Name="SaveButton" Content="Сохранить" 
                                Width="120" Height="35" Margin="5,0" 
                                Background="#FF27AE60" Foreground="White"
                                FontWeight="Bold" Click="SaveButton_Click"/>
                        <Button x:Name="CancelButton" Content="Отмена" 
                                Width="120" Height="35" Margin="5,0" 
                                Background="#FFE74C3C" Foreground="White"
                                FontWeight="Bold" Click="CancelButton_Click"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Border>
    </Grid>
</Page>
